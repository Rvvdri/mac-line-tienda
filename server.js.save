const express = require('express');
const cors = require('cors');
const path = require('path');
const { MongoClient, ObjectId } = require('mongodb');
const nodemailer = require('nodemailer');
const axios = require('axios');

const app = express();

app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));

// ==================== CREDENCIALES ====================

// MONGODB
const MONGODB_URI = 'mongodb+srv://rvvdri:9j8rdlLqR4ACotdY@cluster0.vptvpzv.mongodb.net/macline';

// EMAIL
const EMAIL_USER = 'linemac9190@gmail.com';
const EMAIL_PASSWORD = 'skfxenrvydwaycyc';
const EMAIL_FROM_NAME = 'Mac Line';

// MERCADO PAGO - CAMBIAR CON LAS CREDENCIALES DE TU CLIENTE
const MP_PUBLIC_KEY = 'APP_USR-b1762627-5e4b-4409-88d4-5098974ea645';  // â† CAMBIAR
const MP_ACCESS_TOKEN = 'APP_USR-1539674871672378-021917-5d3634d0ef2f478d31ea2f5db8abeb5d-3208244091';     // â† CAMBIAR
const MP_API_URL = 'https://api.mercadopago.com/v1';

console.log('\nâœ“ SERVIDOR INICIANDO...');
console.log(`âœ“ Email: ${EMAIL_USER}`);
console.log(`âœ“ Mercado Pago: ${MP_ACCESS_TOKEN ? 'CONFIGURADO' : 'NO CONFIGURADO'}\n`);

// ==================== MONGODB ====================
let db;
let productosCollection;
let ventasCollection;

async function conectarMongoDB() {
    try {
        const client = await MongoClient.connect(MONGODB_URI);
        db = client.db('macline');
        productosCollection = db.collection('productos');
        ventasCollection = db.collection('ventas');
        console.log('âœ“ MongoDB conectado correctamente');
    } catch (error) {
        console.error('âŒ Error conectando a MongoDB:', error);
        process.exit(1);
    }
}

// ==================== NODEMAILER ====================

const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
        user: EMAIL_USER,
        pass: EMAIL_PASSWORD
    }
});

transporter.verify((error, success) => {
    if (error) {
        console.log('âŒ Email Error:', error.message);
    } else {
        console.log('âœ“ Email: ConexiÃ³n exitosa');
    }
});

// FunciÃ³n para enviar email de confirmaciÃ³n
async function enviarEmailConfirmacion(cliente, pedido) {
    try {
        const { nombre, email } = cliente;
        const { id, productos, total } = pedido;

        const productosHTML = productos.map(item => `
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${item.nombre}</td>
                <td style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: center;">${item.cantidad}</td>
                <td style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: right;">$${item.precio.toLocaleString('es-CL')}</td>
                <td style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: right;">$${(item.cantidad * item.precio).toLocaleString('es-CL')}</td>
            </tr>
        `).join('');

        const htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                    .container { max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }
                    .header { background: linear-gradient(135deg, #00d4ff 0%, #9333ea 100%); color: white; padding: 20px; border-radius: 8px 8px 0 0; text-align: center; }
                    .content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }
                    .section { margin: 20px 0; padding: 15px; background-color: #f0f4f8; border-left: 4px solid #00d4ff; border-radius: 4px; }
                    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                    th { background-color: #00d4ff; color: white; padding: 12px; text-align: left; }
                    .total-row { font-weight: bold; font-size: 18px; background-color: #e8f0ff; padding: 12px !important; }
                    .success-badge { display: inline-block; background-color: #00d450; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; margin: 10px 0; }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <h1>ğŸ–¥ï¸ MAC LINE</h1>
                        <p>Tienda de TecnologÃ­a Premium</p>
                    </div>
                    <div class="content">
                        <h2>Â¡Hola ${nombre}!</h2>
                        <div class="section">
                            <div class="success-badge">âœ“ PAGO CONFIRMADO</div>
                            <p>Tu compra ha sido procesada correctamente.</p>
                        </div>
                        <h3>Detalle de tu Pedido</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th style="text-align: center;">Cantidad</th>
                                    <th style="text-align: right;">Precio</th>
                                    <th style="text-align: right;">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productosHTML}
                                <tr class="total-row">
                                    <td colspan="3" style="text-align: right;">Total Pagado:</td>
                                    <td style="text-align: right;">$${total.toLocaleString('es-CL')}</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="section">
                            <h3>ğŸ“¦ PrÃ³ximos Pasos</h3>
                            <ol>
                                <li>Tu pedido estÃ¡ siendo procesado</li>
                                <li>Prepararemos tus productos</li>
                                <li>Te notificaremos cuando estÃ© listo para envÃ­o</li>
                            </ol>
                        </div>
                        <div class="section">
                            <p><strong>NÃºmero de Referencia:</strong> #${id}</p>
                            <p><strong>Email:</strong> ${email}</p>
                        </div>
                        <p style="text-align: center; color: #666; font-size: 12px;">&copy; 2024 Mac Line - TecnologÃ­a Premium</p>
                    </div>
                </div>
            </body>
            </html>
        `;

        await transporter.sendMail({
            from: `${EMAIL_FROM_NAME} <${EMAIL_USER}>`,
            to: email,
            subject: 'âœ“ Pago Confirmado - Tu Pedido en Mac Line',
            html: htmlContent
        });

        console.log(`âœ“ Email enviado a ${email}`);
        return true;

    } catch (error) {
        console.error('âŒ Error al enviar email:', error.message);
        return false;
    }
}

// ==================== RUTAS DE PRODUCTOS ====================

app.get('/api/productos', async (req, res) => {
    try {
        const productos = await productosCollection.find({}).toArray();
        res.json(productos);
    } catch (error) {
        console.error('Error al obtener productos:', error);
        res.status(500).json({ error: 'Error al obtener productos' });
    }
});

app.get('/api/productos/:id', async (req, res) => {
    try {
        const producto = await productosCollection.findOne({ id: req.params.id });
        
        if (!producto) {
            return res.status(404).json({ error: 'Producto no encontrado' });
        }
        
        res.json(producto);
    } catch (error) {
        console.error('Error:', error);
        res.status(500).json({ error: 'Error al obtener producto' });
    }
});

app.post('/api/productos', async (req, res) => {
    try {
        const nuevoProducto = {
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            nombre: req.body.nombre,
            categoria: req.body.categoria,
            descripcion: req.body.descripcion,
            precio: req.body.precio,
            precioOriginal: req.body.precioOriginal || null,
            stock: req.body.stock,
            descuento: req.body.descuento || 0,
            emoji: req.body.emoji || 'ğŸ“¦',
            imagenPortada: req.body.imagenPortada || null,
            imagenes: req.body.imagenes || [],
            createdAt: new Date()
        };
        
        await productosCollection.insertOne(nuevoProducto);
        
        res.status(201).json({ 
            success: true, 
            mensaje: 'Producto agregado exitosamente',
            producto: nuevoProducto 
        });
        
    } catch (error) {
        console.error('Error al agregar producto:', error);
        res.status(500).json({ error: 'Error al agregar producto' });
    }
});

app.put('/api/productos/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const datosActualizados = {
            nombre: req.body.nombre,
            categoria: req.body.categoria,
            precio: req.body.precio,
            stock: req.body.stock,
            descuento: req.body.descuento || 0,
            updatedAt: new Date()
        };
        
        Object.keys(datosActualizados).forEach(key => 
            datosActualizados[key] === undefined && delete datosActualizados[key]
        );
        
        const result = await productosCollection.updateOne(
            { id: id },
            { $set: datosActualizados }
        );
        
        if (result.matchedCount === 0) {
            return res.status(404).json({ error: 'Producto no encontrado' });
        }
        
        res.json({ 
            success: true,
            mensaje: 'Producto actualizado exitosamente',
            modificados: result.modifiedCount
        });
        
    } catch (error) {
        console.error('Error al actualizar producto:', error);
        res.status(500).json({ error: 'Error al actualizar producto' });
    }
});

app.delete('/api/productos/:id', async (req, res) => {
    try {
        const { id } = req.params;
        
        console.log(`ğŸ—‘ï¸  Intentando eliminar producto con ID: ${id}`);
        
        const result = await productosCollection.deleteOne({ id: id });
        
        if (result.deletedCount === 0) {
            console.log(`âŒ Producto con ID ${id} no encontrado`);
            return res.status(404).json({ error: 'Producto no encontrado' });
        }
        
        console.log(`âœ… Producto eliminado exitosamente: ${id}`);
        
        res.json({ 
            success: true,
            mensaje: 'Producto eliminado exitosamente',
            id: id
        });
        
    } catch (error) {
        console.error('Error al eliminar producto:', error);
        res.status(500).json({ error: 'Error al eliminar producto: ' + error.message });
    }
});

// ==================== MERCADO PAGO ====================

app.post('/api/crear-preferencia', async (req, res) => {
    try {
        const { nombre, email, telefono, direccion, items, total } = req.body;
        
        if (!nombre || !email || !items || !total) {
            return res.status(400).json({ success: false, error: 'Datos incompletos' });
        }

        console.log('\nğŸ’³ CREANDO PREFERENCIA EN MERCADO PAGO...');

        const preferencia = {
            items: items.map(item => ({
                id: item.id.toString(),
                title: item.nombre,
                quantity: item.cantidad,
                unit_price: item.precio
            })),
            payer: {
                name: nombre,
                email: email,
                phone: {
                    area_code: '+56',
                    number: telefono.replace(/\D/g, '')
                },
                address: {
                    street_name: direccion
                }
            },
            back_urls: {
                success: `${req.protocol}://${req.get('host')}/success.html`,
                failure: `${req.protocol}://${req.get('host')}/failed.html`,
                pending: `${req.protocol}://${req.get('host')}/pending.html`
            },
            auto_return: 'approved',
            notification_url: `${req.protocol}://${req.get('host')}/api/webhook`
        };

        const response = await axios.post(
            `${MP_API_URL}/checkout/preferences`,
            preferencia,
            {
                headers: {
                    'Authorization': `Bearer ${MP_ACCESS_TOKEN}`,
                    'Content-Type': 'application/json'
                }
            }
        );

        console.log('âœ“ Preferencia creada en Mercado Pago');

        // Guardar venta pendiente
        const venta = {
            id: Date.now().toString(),
            fecha: new Date(),
            cliente: { nombre, email, telefono, direccion },
            productos: items,
            total: total,
            estado: 'pendiente',
            mpPreferenceId: response.data.id,
            mpInitPoint: response.data.init_point
        };

        await ventasCollection.insertOne(venta);

        return res.json({
            success: true,
            enlacePago: response.data.init_point,
            preferenceId: response.data.id
        });

    } catch (error) {
        console.error('âŒ Error Mercado Pago:', error.response?.data || error.message);
        res.status(500).json({ 
            success: false,
            error: error.response?.data?.message || 'Error al procesar con Mercado Pago'
        });
    }
});

// Webhook de Mercado Pago
app.post('/api/webhook', async (req, res) => {
    try {
        console.log('ğŸ“¥ Webhook recibido:', req.body);
        
        // AquÃ­ puedes actualizar el estado de la venta segÃºn la notificaciÃ³n
        // y enviar el email de confirmaciÃ³n
        
        res.json({ recibido: true });
    } catch (error) {
        console.error('Error en webhook:', error);
        res.status(500).json({ error: 'Error procesando webhook' });
    }
});

// ==================== RUTAS DE VENTAS ====================

app.get('/api/ventas', async (req, res) => {
    try {
        const ventas = await ventasCollection.find({}).sort({ fecha: -1 }).toArray();
        res.json(ventas);
    } catch (error) {
        console.error('Error al obtener ventas:', error);
        res.status(500).json({ error: 'Error al obtener ventas' });
    }
});

app.post('/api/ventas', async (req, res) => {
    try {
        const nuevaVenta = {
            id: Date.now().toString(),
            fecha: new Date(),
            cliente: {
                nombre: req.body.nombre,
                email: req.body.email,
                telefono: req.body.telefono,
                direccion: req.body.direccion
            },
            productos: req.body.items,
            total: req.body.total,
            estado: 'completada'
        };
        
        await ventasCollection.insertOne(nuevaVenta);
        
        // Enviar email de confirmaciÃ³n
        await enviarEmailConfirmacion(nuevaVenta.cliente, {
            id: nuevaVenta.id,
            productos: nuevaVenta.productos,
            total: nuevaVenta.total
        });
        
        res.json({ 
            success: true,
            mensaje: 'Venta registrada',
            venta: nuevaVenta
        });
        
    } catch (error) {
        console.error('Error al registrar venta:', error);
        res.status(500).json({ error: 'Error al registrar venta' });
    }
});

// ==================== RUTA PARA EL FRONTEND ====================

app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// ==================== INICIAR SERVIDOR ====================

const PORT = process.env.PORT || 3000;

conectarMongoDB().then(() => {
    app.listen(PORT, () => {
        console.log(`\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—`);
        console.log(`â•‘  ğŸ–¥ï¸  MAC LINE - SERVIDOR COMPLETO     â•‘`);
        console.log(`â•‘  âœ“ Puerto: ${PORT}                        â•‘`);
        console.log(`â•‘  âœ“ MongoDB: Conectado                 â•‘`);
        console.log(`â•‘  âœ“ Email: Configurado                 â•‘`);
        console.log(`â•‘  ğŸ’³ Mercado Pago: Configurado         â•‘`);
        console.log(`â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`);
        console.log(`ğŸ“ Tienda:  http://localhost:${PORT}/index.html`);
        console.log(`âš™ï¸  Admin:   http://localhost:${PORT}/admin.html\n`);
    });
});

module.exports = app;









npm start

